#!/usr/bin/env bash
set -euo pipefail

# Default values
CONTAINER_UID="$(id -u)"
CONTAINER_GID="$(id -g)"
DEVICE=""
SAVES_PATH="$(pwd)/saves"
CONFIG_PATH="${XDG_CONFIG_HOME:-$HOME/.config}/proxmark3"
USE_CONFIG=true
IMAGE_NAME="imjasonhk/proxmark3"
IMAGE_TAG="latest"
INTERACTIVE=true
REMOVE_CONTAINER=true
LOG_LEVEL="warn"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help message
show_help() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] [COMMAND]

Run Proxmark3 in a Docker container with configurable options. 

OPTIONS:
    -u, --uid UID           Set container user ID (default: current user's UID)
    -g, --gid GID           Set container group ID (default: current user's GID)
    -d, --device DEVICE     Proxmark3 device path (e.g., /dev/ttyACM0)
    -s, --saves PATH        Path to saves directory (default: ./saves)
    -c, --config PATH       Path to config directory 
                            (default: \${XDG_CONFIG_HOME:-~/.config}/proxmark3)
    --no-config             Don't mount config directory (use container defaults)
    -i, --image IMAGE       Docker image name (default: imjasonhk/proxmark3)
    -t, --tag TAG           Docker image tag (default: latest)
    --log LEVEL             Set log level: debug, info, warn, error (default: warn)
    --no-interactive        Run in non-interactive mode
    --no-remove             Don't remove container after exit
    --privileged            Run with --privileged flag (NOT RECOMMENDED)
    -h, --help              Show this help message

VOLUME MOUNTS:
    Saves : <saves-path> → /proxmark/saves
    Config: <config-path> → /proxmark/.proxmark3 (unless --no-config)
    Device: /dev/tty0 → /dev/tty0 (for pm3 compatibility check)

EXAMPLES:
    # Run with auto-detected device and default paths
    $(basename "$0")

    # Run with specific device
    $(basename "$0") -d /dev/ttyACM0

    # Run with custom UID/GID and paths
    $(basename "$0") -u 1001 -g 1001 -s ~/pm3/saves -c ~/pm3/config

    # Run without persistent config (use container defaults)
    $(basename "$0") -d /dev/ttyACM0 --no-config

    # Run specific pm3 command
    $(basename "$0") -d /dev/ttyACM0 pm3 -c "hf 14a reader"

    # List available firmwares (no device needed)
    $(basename "$0") pm3-firmwares

    # Flash firmware to device
    $(basename "$0") -d /dev/ttyACM0 pm3-flash-all

EOF
}

# Logging functions
log_info() {
    if [[ "$LOG_LEVEL" == "debug" ]] || [[ "$LOG_LEVEL" == "info" ]]; then
        echo -e "[${GREEN}I${NC}] $*"
    fi
}

log_warn() {
    if [[ "$LOG_LEVEL" == "debug" ]] || [[ "$LOG_LEVEL" == "info" ]] || [[ "$LOG_LEVEL" == "warn" ]]; then
        echo -e "[${YELLOW}W${NC}] $*" >&2
    fi
}

log_error() {
    echo -e "[${RED}E${NC}] $*" >&2
}

log_debug() {
    if [[ "$LOG_LEVEL" == "debug" ]]; then
        echo -e "[${BLUE}D${NC}] $*" >&2
    fi
}

# Auto-detect Proxmark3 device
auto_detect_device() {
    local devices=()
    
    # Check common device paths
    for dev in /dev/ttyACM* /dev/ttyUSB* /dev/pm3-*; do
        if [[ -e "$dev" ]]; then
            devices+=("$dev")
        fi
    done
    
    if [[ ${#devices[@]} -eq 0 ]]; then
        # Check if we need to warn based on the command being run
        local needs_device=false
        
        # Check if any arguments were passed
        if [[ $# -gt 0 ]]; then
            local cmd="$1"
            # Warn only for commands that need a device
            case "$cmd" in
                proxmark3|pm3|pm3-flash*|pm3-*)
                    # Exception: pm3-firmwares doesn't need a device
                    if [[ "$cmd" != "pm3-firmwares" ]]; then
                        needs_device=true
                    fi
                    ;;
            esac
        else
            # No command specified, default will need device
            needs_device=true
        fi
        
        if [[ "$needs_device" == true ]]; then
            log_warn "No Proxmark3 device detected, the container will be started without it" >&2
            log_warn "Connect your Proxmark3 device or specify one manually with -d/--device" >&2
        fi
        return 1
    elif [[ ${#devices[@]} -eq 1 ]]; then
        # Output only to stderr to avoid polluting stdout
        log_info "Auto-detected device: ${devices[0]}" >&2
        echo "${devices[0]}"
        return 0
    else
        log_warn "Multiple devices detected:" >&2
        for dev in "${devices[@]}"; do
            echo "  - $dev" >&2
        done
        log_warn "Please specify which device to use with -d/--device" >&2
        return 1
    fi
}

# Parse command line arguments
USE_PRIVILEGED=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--uid)
            CONTAINER_UID="$2"
            shift 2
            ;;
        -g|--gid)
            CONTAINER_GID="$2"
            shift 2
            ;;
        -d|--device)
            if [[ -n "$DEVICE" ]]; then
                log_warn "Device already set to: $DEVICE"
                log_warn "Overriding with: $2"
            fi
            DEVICE="$2"
            shift 2
            ;;
        -s|--saves)
            SAVES_PATH="$2"
            shift 2
            ;;
        -c|--config)
            CONFIG_PATH="$2"
            shift 2
            ;;
        --no-config)
            USE_CONFIG=false
            shift
            ;;
        -i|--image)
            IMAGE_NAME="$2"
            shift 2
            ;;
        -t|--tag)
            IMAGE_TAG="$2"
            shift 2
            ;;
        --log)
            case "$2" in
                debug|info|warn|error)
                    LOG_LEVEL="$2"
                    ;;
                *)
                    log_error "Invalid log level: $2 (must be: debug, info, warn, error)"
                    exit 1
                    ;;
            esac
            shift 2
            ;;
        --no-interactive)
            INTERACTIVE=false
            shift
            ;;
        --no-remove)
            REMOVE_CONTAINER=false
            shift
            ;;
        --privileged)
            USE_PRIVILEGED=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        -*)
            log_error "Unknown option: $1"
            show_help
            exit 1
            ;;
        *)
            # Remaining arguments are the command to run
            break
            ;;
    esac
done

# Validate UID/GID (must match container's validation)
if [[ ! "$CONTAINER_UID" =~ ^[0-9]+$ ]] || [[ "$CONTAINER_UID" -lt 1000 ]] || [[ "$CONTAINER_UID" -gt 65533 ]]; then
    log_error "UID must be a number between 1000 and 65533"
    exit 1
fi

if [[ ! "$CONTAINER_GID" =~ ^[0-9]+$ ]] || [[ "$CONTAINER_GID" -lt 1000 ]] || [[ "$CONTAINER_GID" -gt 65533 ]]; then
    log_error "GID must be a number between 1000 and 65533"
    exit 1
fi

# Auto-detect device if not specified
if [[ -z "$DEVICE" ]]; then
    if detected_device=$(auto_detect_device "$@"); then
        DEVICE="$detected_device"
    fi
fi

# Create and validate saves directory
if [[ ! -d "$SAVES_PATH" ]]; then
    log_info "Creating saves directory: $SAVES_PATH"
    mkdir -p "$SAVES_PATH"
fi

# Convert saves path to absolute path
SAVES_PATH="$(cd "$(dirname "$SAVES_PATH")" && pwd)/$(basename "$SAVES_PATH")"
log_debug "Saves path (absolute): $SAVES_PATH"

# Handle config directory
if [[ "$USE_CONFIG" == true ]]; then
    # Expand tilde and environment variables in CONFIG_PATH
    CONFIG_PATH="${CONFIG_PATH/#\~/$HOME}"
    
    if [[ ! -d "$CONFIG_PATH" ]]; then
        log_info "Creating config directory: $CONFIG_PATH"
        mkdir -p "$CONFIG_PATH"
        log_info "Container will initialize default preferences on first run"
    fi
    
    # Convert config path to absolute path
    CONFIG_PATH="$(cd "$(dirname "$CONFIG_PATH")" && pwd)/$(basename "$CONFIG_PATH")"
    log_debug "Config path (absolute): $CONFIG_PATH"
fi

# Build docker run command
DOCKER_ARGS=(
    "run"
)

# Interactive mode
if [[ "$INTERACTIVE" == true ]]; then
    DOCKER_ARGS+=("-it")
fi

# Remove container after exit
if [[ "$REMOVE_CONTAINER" == true ]]; then
    DOCKER_ARGS+=("--rm")
fi

# Security options
if [[ "$USE_PRIVILEGED" == true ]]; then
    log_warn "Running with --privileged flag (security risk! )"
    DOCKER_ARGS+=("--privileged")
else
    # Recommended security settings
    DOCKER_ARGS+=(
        "--security-opt=no-new-privileges"
        "--cap-drop=ALL"
        "--cap-add=CHOWN"
        "--cap-add=SETUID"
        "--cap-add=SETGID"
    )
fi

# Add device mapping if specified
if [[ -n "$DEVICE" ]]; then
    if [[ !  -e "$DEVICE" ]]; then
        log_error "Device not found: $DEVICE"
        exit 1
    fi
    
    # Check if we have read/write access to the device
    if [[ ! -r "$DEVICE" ]] || [[ ! -w "$DEVICE" ]]; then
        log_warn "Limited access to $DEVICE"
        log_warn "You may need to add your user to the 'dialout' group:"
        log_warn "  sudo usermod -aG dialout \$USER"
        log_warn "Then log out and back in for changes to take effect"
    fi
    
    DOCKER_ARGS+=("--device=$DEVICE")
    log_debug "Device mapping: $DEVICE"
fi

# Mount /dev/tty0 for pm3 compatibility check (unless it's already the main device)
if [[ "$DEVICE" != "/dev/tty0" ]] && [[ !  "$USE_PRIVILEGED" == true ]]; then
    if [[ -c "/dev/tty0" ]]; then
        DOCKER_ARGS+=("--device=/dev/tty0")
        log_debug "Mounting /dev/tty0 for pm3 compatibility check"
    else
        log_debug "/dev/tty0 not found, skipping mount"
    fi
fi

# Environment variables
DOCKER_ARGS+=(
    "-e" "UID=$CONTAINER_UID"
    "-e" "GID=$CONTAINER_GID"
)

# Volume mounts
DOCKER_ARGS+=(
    "-v" "${SAVES_PATH}:/proxmark/saves"
)

if [[ "$USE_CONFIG" == true ]]; then
    DOCKER_ARGS+=(
        "-v" "${CONFIG_PATH}:/proxmark/.proxmark3"
    )
fi

# Image name
DOCKER_ARGS+=("${IMAGE_NAME}:${IMAGE_TAG}")

# Command to run (default from Dockerfile if not specified)
if [[ $# -gt 0 ]]; then
    DOCKER_ARGS+=("$@")
fi

# Print summary
log_info "════════════════════════════════════════════════════════════"
log_info "Docker Container Configuration"
log_info "════════════════════════════════════════════════════════════"
log_info "Image   : ${IMAGE_NAME}:${IMAGE_TAG}"
log_info "UID/GID : ${CONTAINER_UID}:${CONTAINER_GID}"
log_info "Saves   : ${SAVES_PATH}"
if [[ "$USE_CONFIG" == true ]]; then
    log_info "Config  : ${CONFIG_PATH}"
else
    log_info "Config  : <using container defaults>"
fi
if [[ -n "$DEVICE" ]]; then
    log_info "Device  : ${DEVICE}"
else
    log_info "Device  : <none - offline mode>"
fi
if [[ "$USE_PRIVILEGED" == true ]]; then
    log_warn "Security: PRIVILEGED MODE"
else
    log_info "Security: Standard (no-new-privileges, minimal caps)"
fi
log_info "════════════════════════════════════════════════════════════"

# Show the actual docker command in debug mode
if [[ "$LOG_LEVEL" == "debug" ]]; then
    log_debug "Full docker command:"
    log_debug "docker ${DOCKER_ARGS[*]}"
fi

# Execute docker run
exec docker "${DOCKER_ARGS[@]}"
